PRD 1.0: Sistema SaaS FASTBEAUTYPRO (Gest√£o de Barbearias)
1. Vis√£o Geral do Projeto
O FASTBEAUTYPRO  √© uma plataforma SaaS multi-tenant (v√°rias empresas em um s√≥ banco de dados) focada na digitaliza√ß√£o completa da opera√ß√£o de uma barbearia. O sistema resolve tr√™s dores principais: a desorganiza√ß√£o de agendamentos, o furo de estoque e a demora no fechamento de comiss√µes. As plataformas utilizadas a princ√≠pio ser√£o GitHub (reposit√≥rio do c√≥digo-fonte), Supabase (banco de dados) e Vercel (hospedagem).

2. Perfis de Usu√°rios e Acessos
Perfil
Tipo de Acesso
Identifica√ß√£o
Responsabilidades
Cliente
URL P√∫blica √önica
N/A
Agendamento via web sem login obrigat√≥rio.
Barbeiro
Painel Restrito
E-mail ou CPF
Gest√£o de agenda, abertura de comanda e vendas.
Propriet√°rio
Painel Administrativo da barbearia
E-mail ou CPF
Gest√£o financeira, estoque, aprova√ß√£o de equipe e configura√ß√£o.
Administrador Master
Painel Administrativo geral e com todas as permiss√µes
E-mail ou CPF
Gest√£o completa de todas as barbearias


3. Jornadas do Usu√°rio (Fluxo Passo a Passo)
3.1. Jornada do Cliente (O Agendamento)
O cliente acessa a URL exclusiva da barbearia (Ex:http://elitebarber.com/barbearia-do-ze). Url feita com o slug do nome da barbearia cadastrada.
Escolhe o Servi√ßo $\rightarrow$ Escolhe o Barbeiro $\rightarrow$ Escolhe Dia e Hor√°rio.
Preenche dados b√°sicos (Nome/WhatsApp) e √© direcionado para o WhatsApp do barbeiro com uma mensagem pr√©-pronta para confirma√ß√£o manual.
Tamb√©m abrir√° uma p√°gina de Agradecimento com um card dos servi√ßos agendados, valor, hor√°rio, barbeiro, etc. Ter√£o 3 bot√µes: 1. Fazer Novo Agendamento 2.Reenviar Agendamento pelo WhatsApp 3. Sair (1 e 2 retornar√£o para a p√°gina inicial de agendamento da referida barbearia barbearia)
O agendamento √© registrado no banco com status Pendente.
3.2. Jornada do Barbeiro j√° cadastrado e aceito pela barbearia (A Opera√ß√£o)
Login: Realizado em aba espec√≠fica ('Sou Barbeiro') via E-mail ou CPF.
Agenda: Visualiza apenas seus agendamentos do dia.
A√ß√µes:
Cliente Ausente: Marca o "no-show". O status muda para ausente.
Abrir Comanda: Ao iniciar o servi√ßo, abre a comanda que j√° vem pr√©-preenchida com o servi√ßo agendado.
Venda Adicional: O barbeiro pode incluir outros servi√ßos ou produtos (com fotos) na comanda.
Regra de Ouro: O barbeiro n√£o altera pre√ßos. Ele apenas seleciona itens com valores pr√©-definidos pelo dono.
Trava de Estoque: Se o produto tiver estoque = 0, ele n√£o aparece para adi√ß√£o.
Finaliza√ß√£o: Salva no bot√£o ‚ÄúFinalizado‚Äù e envia a comanda para o status Aguardando Pagamento.
3.3. Jornada do Administrador (O Caixa e Gest√£o)
Cadastramento: O propriet√°rio da barbearia pode realizar seu pr√≥prio cadastro na plataforma com os dados relevantes do seu neg√≥cio.
Ao acessar o seu painel administrativo pela primeira vez, aparecer√° uma mensagem de bloqueio do sistema com duas mensagens separadas por ‚Äú_ ou_‚Äù: 1. ‚ÄúPara acessar o Painel Administrativo, realize o pagamento de sua mensalidade.‚Äù e logo abaixo 2. ‚ÄúDigite seu CUPOM PROMOCIONAL de acesso.‚Äù
Aprova√ß√£o: Recebe solicita√ß√µes de novos barbeiros que se cadastraram no sistema e decide quem ativar.
Equipe: pode cadastrar barbeiros com foto e tem a gest√£o completa de toda a equipe (editar cadastro, desativar/ativar, excluir)
Caixa (Checkout): Visualiza as comandas enviadas pelos barbeiros.
Pode adicionar produtos extras (venda de balc√£o), tamb√©m pode excluir √≠tens, alterar quantidades, pode conceder descontos (porcentagem ou valor) mas n√£o pode alterar pre√ßos diretamente na comanda. A comiss√£o de cada comanda ir√° para o barbeiro que iniciou o atendimento do cliente. Confirma o recebimento (Pagamento manual: Dinheiro/Pix/Cart√£o de credito/d√©bito).
Estoque: Cadastra produtos com Foto, Pre√ßo, Qtd Atual e Estoque M√≠nimo.
Recebe alertas visuais de itens em "N√≠vel Cr√≠tico".
Fechamento: O sistema calcula automaticamente a comiss√£o (porcentagem ou valor  fixo) de cada barbeiro com base nos servi√ßos e produtos vendidos.
Financeiro: possui acesso total e completo de indicadores financeiros para controle e gest√£o.
Agenda: possui acesso a agenda geral dos barbeiros
3.4. Jornada do Administrador Master (Gest√£o de todas as barbearias cadastradas)
Tem acesso √∫nico e exclusivo ao seu painel administrativo que gerencia e tem acesso para a gest√£o de todas as barbearias cadastradas (editar cadastro, desativar/ativar, excluir)
Possui alguns indicadores estrat√©gicos para a tomada de decis√µes e oportunidades no neg√≥cio.
Pode criar cupons para aplicar no perfil das barbearia e assim conceder descontos, tempo de acesso gr√°tis, etc)

4. Requisitos Funcionais (Regras de Neg√≥cio)
4.1. Seguran√ßa e Multi-tenancy
Isolamento de Dados (RLS): Uma barbearia nunca pode ver os dados, clientes ou financeiros de outra.
Hierarquia de Rotas: Barbeiros s√£o terminantemente proibidos de acessar a rota /admin.
Arquitetura do banco de dados: deve ser inteligentemente constru√≠da e eficiente buscando a economia de espa√ßo de armazenamento a m√©dio e longo prazo.
Fotos enviadas: devem ser comprimidas e convertidas para o formato webp no momento do envio e serem armazenadas na √°rea do Supabase Storage para n√£o aumentar o banco de dados.
4.2. Motor de Estoque
Baixa Autom√°tica: O estoque s√≥ √© subtra√≠do quando o Administrador confirma o pagamento da comanda.
Impossibilidade de Venda Negativa: O sistema deve impedir que barbeiros ou admins lancem produtos com saldo zero.
4.3. Comiss√µes
C√°lculo Autom√°tico: Baseado em valores fixos ou porcentagens fixas setadas no perfil do barbeiro (Ex: 50% servi√ßo, 10% produto, R$5,00 produto).
Base de C√°lculo: O valor para comiss√£o √© o valor final da comanda processada no caixa.

5. Especifica√ß√µes T√©cnicas (O "Stack")
Frontend: Next.js 14 (App Router) + Tailwind CSS.
Backend/Banco: Supabase (PostgreSQL).
Autentica√ß√£o: Supabase Auth com metadados para distinguir owner de barber.
√Årea exclusiva:  de autentica√ß√£o do Administrador Master (ex. http://elitebarber.com/login-master)
Armazenamento de Imagens: Supabase Storage (Buckets para fotos de produtos e perfil).
Estado: Sem integra√ß√µes externas de pagamento (Asaas) ou automa√ß√£o de WhatsApp (Evolution API) nesta vers√£o. Tudo √© processado internamente.
A p√°gina inicial do projeto (ex. http://elitebarber.com) ser√° destinada para uma futura landing page. o sistema dever√° ser acessado por (ex. http://elitebarber.com/sistema). Na tela do sistema, aparecem dois links: 1. (Acessar Painel Administrativo - (ex. http://elitebarber.com/login - onde haver√° a tela de login hibrida tanto para administradores quanto para barbeiros) e 2. Adm Master (ex, http://elitebarber.com/login-master) localizado de forma discreta e com fonte menor e afastado do outro link e bem pr√≥ximo do rodap√©)
6. Diferenciais Estrat√©gicos para Implementa√ß√£o
Login H√≠brido: O sistema deve aceitar CPF ou E-mail como identificador √∫nico.
Interface Mobile-First (Responsividade total): O barbeiro trabalha com o celular na m√£o; a tela de comanda deve ser extremamente r√°pida e intuitiva. O administrador tamb√©m pode acessar e  trabalhar com o celular na m√£o; as telas de todo o sistema de gest√£o deves ser extremamente r√°pida e intuitiva tamb√©m..
Autonomia Controlada: O barbeiro tem autonomia para adicionar e excluir itens e mudar quantidades , mas o Administrador det√©m o controle dos pre√ßos e do estoque.
7. Orienta√ß√µes T√©cnicas e Arquitetura de Alta Performance
Para garantir que o Elite Barber seja enxuto, r√°pido e modular (permitindo ligar/desligar fun√ß√µes), a implementa√ß√£o deve seguir estes pilares:
7.1. Arquitetura Modular (Feature-First)
Em vez de organizar o c√≥digo por tipo (componentes, telas), utilizaremos a Screaming Architecture. O c√≥digo ser√° agrupado por Dom√≠nios de Neg√≥cio:
modules/booking: L√≥gica de agendamento e calend√°rio.
modules/inventory: Gest√£o de produtos e estoque.
modules/checkout: Comandas e processamento de pagamentos.
modules/admin-master: Regras globais, cupons e gest√£o de tenants.
Benef√≠cio: Facilita a ativa√ß√£o/desativa√ß√£o de m√≥dulos via "Feature Flags" (booleanos no banco de dados que liberam ou escondem rotas e bot√µes).
7.2. Engenharia de Dados e Performance no Supabase
Normaliza√ß√£o Eficiente: Tabelas de jun√ß√£o (order_items) para evitar duplicidade de dados e √≠ndices compostos em tenant_id para buscas instant√¢neas.
Edge Computing: Uso de Database Functions (PL/pgSQL) para c√°lculos de comiss√£o e baixa de estoque diretamente no banco. Isso reduz o tr√°fego de dados entre Vercel e Supabase, tornando a opera√ß√£o at√¥mica (ou faz tudo, ou n√£o faz nada, evitando erros de saldo).
RLS (Row Level Security) Blindado: Uma √∫nica pol√≠tica global garante que nenhum dado escape do contexto do tenant_id da barbearia logada.
7.3. Pipeline de M√≠dia Inteligente
Processamento de Imagem: Implementa√ß√£o de um Edge Function ou trigger que intercepta o upload no Supabase Storage, comprime e converte automaticamente para WebP (redu√ß√£o de at√© 80% no peso sem perda visual percept√≠vel).
Cache Estrat√©gico: Uso de headers de cache agressivos para fotos de produtos, evitando requisi√ß√µes desnecess√°rias ao storage.
7.4. Componentiza√ß√£o At√¥mica e UI Reutiliz√°vel
Design System Pr√≥prio: Cria√ß√£o de uma biblioteca de componentes base (Buttons, Inputs, Modals, Cards) usando Tailwind CSS + Headless UI/Shadcn.
Renderiza√ß√£o H√≠brida (Next.js 14):
Server Components (RSC): Para listagens e dashboards (carregamento ultra r√°pido e melhor SEO).
Client Components: Apenas para intera√ß√µes cr√≠ticas (abertura de comanda, sele√ß√£o de hor√°rio).
Skeleton States: Uso de carregamento progressivo para que o usu√°rio nunca veja uma tela em branco, aumentando a percep√ß√£o de velocidade.
7.5. Estrat√©gia de Sustentabilidade (C√≥digo Enxuto)
Shared Logic Hooks: Toda a l√≥gica de "verificar estoque" ou "calcular comiss√£o" ser√° isolada em Custom Hooks reaproveit√°veis tanto no painel do barbeiro quanto no do admin.
Tree Shaking: Configura√ß√£o rigorosa do bundle para garantir que o navegador do usu√°rio carregue apenas o CSS e JS estritamente necess√°rio para aquela p√°gina espec√≠fica.
Zustand para Estado Global: Uma biblioteca de estado extremamente leve para gerenciar informa√ß√µes do usu√°rio logado e da barbearia atual sem o overhead do Redux ou Context API complexo.
8. Estrutura de Pastas Sugerida: Elite Barber v1.0
Observa√ß√£o: esta √© apenas uma sugest√£o de pastas, podendo ser adaptada da melhor forma pelo Antigravity.
Plaintext
/
‚îú‚îÄ‚îÄ .github/              # Workflows para CI/CD (Deploy autom√°tico Vercel)
‚îú‚îÄ‚îÄ supabase/             # Configura√ß√µes do Backend
‚îÇ   ‚îú‚îÄ‚îÄ migrations/       # Scripts SQL para versionamento do banco
‚îÇ   ‚îú‚îÄ‚îÄ functions/        # Edge Functions (Ex: Processamento de imagens WebP)
‚îÇ   ‚îî‚îÄ‚îÄ seed.sql          # Dados iniciais para teste (Planos, Master Admin)
‚îú‚îÄ‚îÄ public/               # Ativos est√°ticos (Logo, √çcones)
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ app/              # Next.js App Router (Roteamento e Layouts)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ (auth)/       # Agrupamento de rotas de login/cadastro
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ (system)/     # Agrupamento de rotas logadas (/sistema)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ [slug]/       # URL din√¢mica para agendamento do cliente
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin-master/ # Painel exclusivo do Administrador Master
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ api/          # Endpoints internos (Webhooks, etc.)
‚îÇ   ‚îú‚îÄ‚îÄ components/       # UI At√¥mica (Reutiliz√°vel)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ui/           # Componentes base (Bot√µes, Inputs, Modais - Shadcn)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ shared/       # Componentes usados em mais de um m√≥dulo
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ forms/        # Componentes de formul√°rio complexos
‚îÇ   ‚îú‚îÄ‚îÄ hooks/            # Hooks customizados globais
‚îÇ   ‚îú‚îÄ‚îÄ lib/              # Configura√ß√µes de terceiros (supabaseClient, utils)
‚îÇ   ‚îú‚îÄ‚îÄ modules/          # O CORA√á√ÉO DO PROJETO (L√≥gica Modular)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ booking/      # Regras, tipos e componentes de Agendamento
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ inventory/    # Regras de Estoque e Produtos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ checkout/     # L√≥gica de Comandas e Comiss√µes
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ management/   # Gest√£o de Equipe e Tenants (Barbearias)
‚îÇ   ‚îú‚îÄ‚îÄ services/         # Camada de comunica√ß√£o direta com Supabase
‚îÇ   ‚îú‚îÄ‚îÄ store/            # Gerenciamento de estado global (Zustand)
‚îÇ   ‚îú‚îÄ‚îÄ types/            # Defini√ß√µes de TypeScript (Interfaces do Banco)
‚îÇ   ‚îî‚îÄ‚îÄ utils/            # Helpers de formata√ß√£o (Moeda, CPF, Datas)
‚îú‚îÄ‚îÄ middleware.ts         # Prote√ß√£o de rotas e controle de acesso (RBAC)
‚îú‚îÄ‚îÄ tailwind.config.ts    # Configura√ß√µes de design system
‚îî‚îÄ‚îÄ next.config.js        # Configura√ß√µes do framework


9.1. Por que esta sugest√£o de estrutura √© a melhor solu√ß√£o?
Isolamento de Erros: Se voc√™ precisar desativar o m√≥dulo de "Estoque" no futuro por qualquer motivo, voc√™ mexe apenas na pasta modules/inventory. O resto do sistema permanece intacto.
Velocidade de Desenvolvimento: O Antigravity poder√° reutilizar os componentes da pasta components/ui em todos os pain√©is (Barbeiro, Admin e Master), mantendo a identidade visual sem duplicar c√≥digo.
Seguran√ßa (Middleware): O arquivo middleware.ts na raiz agir√° como um "porteiro", verificando em cada clique se o usu√°rio tem permiss√£o para acessar aquela pasta espec√≠fica (/admin ou /admin-master).
Escalabilidade: Quando voc√™ decidir adicionar o m√≥dulo de "Pagamento via Asaas", basta criar modules/payments, sem poluir as pastas de agendamento.
Observa√ß√£o: esta estrutura √© uma sugest√£o e pode ser alterada conforme necessidade pelo Antigravity.

10. Script SQL
Este script SQL abaixo √© a "espinha dorsal" do seu projeto. Ele foi estruturado para o Supabase, garantindo que o isolamento de dados (Multi-tenancy) seja nativo e que as regras de neg√≥cio (como estoque e comiss√µes) estejam protegidas diretamente no banco de dados.
Observa√ß√£o: esta estrutura √© uma sugest√£o e pode ser alterada conforme necessidade pelo Antigravity.

Copie e execute este c√≥digo no SQL Editor do seu projeto no Supabase:


-- 1. EXTENS√ïES E TIPOS (ENUMS)
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

CREATE TYPE user_role AS ENUM ('master', 'owner', 'barber');
CREATE TYPE user_status AS ENUM ('pending', 'active', 'suspended');
CREATE TYPE order_status AS ENUM ('open', 'awaiting_payment', 'completed', 'absent');

-- 2. TABELA DE BARBEARIAS (TENANTS)
CREATE TABLE tenants (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name TEXT NOT NULL,
    slug TEXT UNIQUE NOT NULL, -- elitebarber.com/sistema/slug
    logo_url TEXT,
    active BOOLEAN DEFAULT true,
    trial_ends_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 3. PERFIS DE USU√ÅRIOS (BARBEIROS E PROPRIET√ÅRIOS)
-- Integrado ao auth.users do Supabase
CREATE TABLE profiles (
    id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    tenant_id UUID REFERENCES tenants(id),
    full_name TEXT NOT NULL,
    cpf TEXT UNIQUE NOT NULL,
    email TEXT UNIQUE NOT NULL,
    role user_role NOT NULL DEFAULT 'barber',
    status user_status NOT NULL DEFAULT 'pending',
    avatar_url TEXT,
    service_commission DECIMAL(10,2) DEFAULT 0, -- % ou valor fixo
    product_commission DECIMAL(10,2) DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 4. TABELA DE SERVI√áOS
CREATE TABLE services (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    description TEXT,
    price DECIMAL(10,2) NOT NULL,
    duration_minutes INTEGER NOT NULL,
    active BOOLEAN DEFAULT true
);

-- 5. TABELA DE PRODUTOS (ESTOQUE)
CREATE TABLE products (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    price DECIMAL(10,2) NOT NULL,
    image_url TEXT,
    current_stock INTEGER NOT NULL DEFAULT 0,
    min_stock INTEGER NOT NULL DEFAULT 0,
    active BOOLEAN DEFAULT true
);

-- 6. AGENDAMENTOS
CREATE TABLE appointments (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,
    barber_id UUID REFERENCES profiles(id),
    service_id UUID REFERENCES services(id),
    customer_name TEXT NOT NULL,
    customer_whatsapp TEXT NOT NULL,
    scheduled_at TIMESTAMP WITH TIME ZONE NOT NULL,
    status order_status DEFAULT 'open',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 7. COMANDAS (ORDERS) E ITENS
CREATE TABLE orders (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,
    appointment_id UUID REFERENCES appointments(id),
    barber_id UUID REFERENCES profiles(id),
    total_value DECIMAL(10,2) DEFAULT 0,
    discount_value DECIMAL(10,2) DEFAULT 0,
    payment_method TEXT, -- 'pix', 'card', 'cash'
    status order_status DEFAULT 'open',
    finalized_at TIMESTAMP WITH TIME ZONE
);

CREATE TABLE order_items (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    order_id UUID REFERENCES orders(id) ON DELETE CASCADE,
    product_id UUID REFERENCES products(id),
    service_id UUID REFERENCES services(id),
    quantity INTEGER NOT NULL DEFAULT 1,
    unit_price DECIMAL(10,2) NOT NULL, -- Pre√ßo travado no momento da venda
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 8. CUPONS (ADMIN MASTER)
CREATE TABLE coupons (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    code TEXT UNIQUE NOT NULL,
    description TEXT,
    discount_days INTEGER, -- Dias de acesso gr√°tis
    active BOOLEAN DEFAULT true
);

-- 9. SEGURAN√áA (ROW LEVEL SECURITY - RLS)
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE services ENABLE ROW LEVEL SECURITY;
ALTER TABLE products ENABLE ROW LEVEL SECURITY;
ALTER TABLE appointments ENABLE ROW LEVEL SECURITY;
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE order_items ENABLE ROW LEVEL SECURITY;

-- Exemplo de pol√≠tica: Usu√°rio s√≥ v√™ dados do seu pr√≥prio Tenant
CREATE POLICY "Tenant isolation" ON profiles 
    FOR ALL USING (tenant_id = (SELECT tenant_id FROM profiles WHERE id = auth.uid()));

-- 10. TRIGGER PARA BAIXA DE ESTOQUE AUTOM√ÅTICA
CREATE OR REPLACE FUNCTION handle_stock_reduction()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.status = 'completed' AND OLD.status <> 'completed' THEN
        UPDATE products p
        SET current_stock = p.current_stock - oi.quantity
        FROM order_items oi
        WHERE oi.order_id = NEW.id AND oi.product_id = p.id;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_stock_reduction
AFTER UPDATE ON orders
FOR EACH ROW EXECUTE FUNCTION handle_stock_reduction();

Por que este SQL √© perfeito para o seu PRD?
Multi-tenancy Nativo: O campo tenant_id em todas as tabelas, aliado ao RLS (Row Level Security), garante que a barbearia do "Jo√£o" nunca veja os clientes da barbearia do "Jos√©".
Travamento de Pre√ßo: Na tabela order_items, salvamos o unit_price. Isso evita que, se o dono mudar o pre√ßo de um servi√ßo hoje, o relat√≥rio de vendas do m√™s passado seja alterado.
Estoque Blindado: O TRIGGER que criei garante que o estoque s√≥ seja baixado no exato momento em que o Administrador marca a comanda como completed.
Flexibilidade de Comiss√µes: O perfil do barbeiro j√° conta com campos para comiss√£o de servi√ßo e produto separadamente.
Master Admin: A tabela coupons e o campo trial_ends_at em tenants permitem que voc√™ gerencie quem est√° pagando ou quem usou um cupom.
O Middleware no Next.js 14 √© o "seguran√ßa" da sua aplica√ß√£o. Ele intercepta cada requisi√ß√£o antes de ela chegar √† p√°gina e decide se permite o acesso, bloqueia ou redireciona o utilizador.
Para o Elite Barber, o Middleware precisa de validar tr√™s coisas:
Autentica√ß√£o: O utilizador est√° logado?
Autoriza√ß√£o (RBAC): O utilizador tem a "fun√ß√£o" certa (Master, Owner ou Barber) para aceder a esta rota?
Status do Tenant: A barbearia est√° com a mensalidade em dia ou tem um cupom v√°lido?
Aqui est√° a implementa√ß√£o t√©cnica para o ficheiro middleware.ts na raiz do seu projeto:

üõ°Ô∏è Implementa√ß√£o: middleware.ts
TypeScript
import { createMiddlewareClient } from '@supabase/auth-helpers-nextjs';
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export async function middleware(req: NextRequest) {
  const res = NextResponse.next();
  const supabase = createMiddlewareClient({ req, res });

  // 1. Verificar se existe uma sess√£o ativa
  const { data: { session } } = await supabase.auth.getSession();

  const url = req.nextUrl.clone();
  const path = url.pathname;

  // 2. Definir as rotas p√∫blicas (que n√£o precisam de login)
  const isPublicRoute = path === '/' || path === '/sistema' || path === '/login' || path === '/login-master' || path.startsWith('/[slug]');

  if (!session && !isPublicRoute) {
    // Se n√£o est√° logado e tenta aceder a √°rea protegida -> Login
    url.pathname = '/login';
    return NextResponse.redirect(url);
  }

  if (session) {
    // 3. Procurar o perfil do utilizador e o status da barbearia (Tenant)
    const { data: profile } = await supabase
      .from('profiles')
      .select('role, status, tenant_id, tenants(active, trial_ends_at)')
      .eq('id', session.user.id)
      .single();

    // 4. Bloqueio de Utilizador Pendente ou Suspenso
    if (profile?.status !== 'active' && !path.startsWith('/aguardando-aprovacao')) {
      url.pathname = '/aguardando-aprovacao';
      return NextResponse.redirect(url);
    }

    // 5. Prote√ß√£o de Rotas por N√≠vel de Acesso (RBAC)
    
    // Admin Master: S√≥ acede a /admin-master
    if (path.startsWith('/admin-master') && profile?.role !== 'master') {
      url.pathname = '/sistema';
      return NextResponse.redirect(url);
    }

    // Propriet√°rio (Owner): N√£o acede a /admin-master nem a √°reas exclusivas de barbeiros
    if (path.startsWith('/admin') && profile?.role !== 'owner') {
      url.pathname = '/profissional';
      return NextResponse.redirect(url);
    }

    // Barbeiro: Proibido de entrar em /admin ou /admin-master
    if ((path.startsWith('/admin') || path.startsWith('/admin-master')) && profile?.role === 'barber') {
      url.pathname = '/profissional';
      return NextResponse.redirect(url);
    }

    // 6. Verifica√ß√£o de Pagamento/Bloqueio (Regra do PRD)
    const isTenantActive = profile?.tenants?.active;
    const isTrialValid = new Date(profile?.tenants?.trial_ends_at || 0) > new Date();

    if (profile?.role === 'owner' && !isTenantActive && !isTrialValid && !path.startsWith('/pagamento-pendente')) {
      url.pathname = '/pagamento-pendente';
      return NextResponse.redirect(url);
    }
  }

  return res;
}

// Configurar em quais caminhos o Middleware deve rodar
export const config = {
  matcher: [
    '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
  ],
};


üí° O que este Middleware garante para o seu projeto:
Isolamento de Pap√©is: Um barbeiro nunca conseguir√° digitar /admin na URL e aceder aos dados financeiros. O sistema ir√° redirecion√°-lo instantaneamente para /profissional.
Bloqueio de Inadimplentes: Conforme o seu PRD, o Propriet√°rio que n√£o pagou a mensalidade ou n√£o tem um cup√£o v√°lido ser√° "preso" na p√°gina /pagamento-pendente at√© regularizar a situa√ß√£o.
Experi√™ncia do Cliente Preservada: O Middleware ignora as rotas din√¢micas como /[slug], permitindo que os clientes agendem servi√ßos livremente sem que o sistema pe√ßa login.
Seguran√ßa Master: A rota /admin-master fica blindada, sendo acess√≠vel apenas por utilizadores com a role master definida no banco de dados.

Plataforma H√≠brida para Barbearias e Sal√µes de Beleza
Para transformar o seu sistema em uma plataforma h√≠brida (Barbearia/Sal√£o) mantendo a mesma estrutura de c√≥digo, a solu√ß√£o t√©cnica mais elegante e eficiente √© o uso de Temas baseados em Vari√°veis CSS (Design Tokens).
A escolha de em qual tema prosseguir, ser√° feita na tela inicial do sistema, apresentando as duas op√ß√µes.
Dessa forma, o c√≥digo n√£o muda; o que muda √© a "roupa" (o tema) que o sistema veste com base no business_type cadastrado no banco de dados.

1. Ajuste no Banco de Dados (Supabase)
Primeiro, precisamos que o sistema saiba qual "personalidade" assumir. Adicionaremos uma coluna na tabela de tenants:
SQL
ALTER TABLE tenants 
ADD COLUMN business_type TEXT CHECK (business_type IN ('barber', 'salon')) DEFAULT 'barber';


2. Estrat√©gia de Cores: Design Tokens
Em vez de usar cores fixas como bg-zinc-900 ou text-amber-500 diretamente em todos os lugares, utilizaremos vari√°veis de tema.
Sugest√£o de Paleta para Sal√£o de Beleza:
Enquanto a barbearia usa o contraste Black/Zinc/Amber, o sal√£o pode seguir uma linha "Soft Premium":
Background: Rose-50 (Claro) ou Zinc-950 (Escuro sofisticado).
A√ß√£o (Prim√°ria): Rose-500 ou Violet-400 (Substitui o Amber).
Contrastes: Tons de Slate ou Gray mais suaves.

3. Implementa√ß√£o T√©cnica com Tailwind CSS
Configuraremos o arquivo globals.css para injetar as cores dinamicamente atrav√©s de uma classe no body ou em uma div pai.
CSS
/* globals.css */
@layer base {
  /* Tema Padr√£o: Barbearia */
  .theme-barber {
    --color-background: 0 0% 0%;    /* Black */
    --color-surface: 240 5% 10%;    /* Zinc-900 */
    --color-primary: 38 92% 50%;    /* Amber-500 */
    --color-text: 240 5% 96%;       /* Zinc-100 */
  }

  /* Tema: Sal√£o de Beleza */
  .theme-salon {
    --color-background: 320 20% 98%; /* Soft Rose/White */
    --color-surface: 0 0% 100%;      /* Pure White */
    --color-primary: 330 80% 60%;    /* Rose/Pink Moderno */
    --color-text: 240 10% 20%;       /* Dark Gray */
  }
}

No tailwind.config.ts, voc√™ mapeia essas vari√°veis:
TypeScript
theme: {
  extend: {
    colors: {
      background: 'hsl(var(--color-background))',
      primary: 'hsl(var(--color-primary))',
      surface: 'hsl(var(--color-surface))',
    }
  }
}


4. Como o Sistema Muda de "Cara" Automaticamente?
No seu layout.tsx (Root Layout), voc√™ busca o tipo de neg√≥cio do usu√°rio logado e aplica a classe correspondente:
TypeScript
// Exemplo simplificado no layout
export default function RootLayout({ children }) {
  const themeClass = tenant.business_type === 'salon' ? 'theme-salon' : 'theme-barber';

  return (
    <html lang="pt-br">
      <body className={themeClass}>
        {children}
      </body>
    </html>
  );
}


5. Adapta√ß√µes M√≠nimas de Conte√∫do
Para que a experi√™ncia seja completa, voc√™ pode usar um simples "dicion√°rio" de termos:
Exemplo de l√≥gica de tradu√ß√£o interna:
Se type === 'barber', use o termo "Barbeiro".
Se type === 'salon', use o termo "Profissional" ou "Esteticista".

Benef√≠cios desta Solu√ß√£o:
C√≥digo √önico: Voc√™ corrige um bug no checkout e ele √© corrigido para ambos os modelos simultaneamente.
Escalabilidade: Se amanh√£ voc√™ quiser criar um tema para "Pet Shop", basta adicionar uma nova classe CSS e um novo tipo no banco.
Performance: N√£o h√° carregamento de arquivos diferentes; o CSS √© processado de uma vez s√≥ pelo Tailwind.







